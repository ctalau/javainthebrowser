<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="lib/codemirror.css">
    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/docs.css">

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="text/css" rel="stylesheet" href="Jib.css">

    <title>Java in the Browser Demo (alpha)</title>

    <script type="text/javascript" language="javascript" src="jib/jib.nocache.js"></script>
  </head>

  <body>

    <iframe src="javascript:''" id="__gwt_historyFrame" tabIndex='-1' style="position:absolute;width:0;height:0;border:0"></iframe>

    <!-- RECOMMENDED if your web app will not function without JavaScript enabled -->
    <noscript>
      <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
      </div>
    </noscript>
    <a href="https://github.com/ctalau/javainthebrowser">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
    </a>
    <h1>Java in the Browser Demo</h1>

    <div>
      <div style="float: left; width: 100%; border: 1px solid black; padding: 4px;">
        <textarea id="source" rows="25">
public class HelloWorld {
  public static void main(String[] args) {
    System.out.println("Hello, World!");
  }
}
        </textarea>
      </div>

      <div style="float: left; width: 100%" id="log-div">
      </div>

      <div style="float: left; width:100%; text-align:center" id="btn-div">
      </div>

      <div style="float: left; width: 100%; margin-top: 10px;">
        <button id="toggle-debug-btn" style="margin-bottom: 10px;">Toggle Debug Logs</button>
        <div id="debug-log" style="display: none; border: 1px solid #666; padding: 10px; background: #f5f5f5; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
        </div>
      </div>
    </div>

    <script>
      editor = CodeMirror.fromTextArea(document.getElementById('source'), {
        parserfile: ["tokenizejava.js", "parsejava.js"],
        stylesheet: "lib/javacolors.css",
        path: "lib/", tabMode : "shift",
      });
    </script>

    <script>
      // Debug logging system
      window.debugLog = (function() {
        const debugLogDiv = document.getElementById('debug-log');
        const toggleBtn = document.getElementById('toggle-debug-btn');

        function formatTimestamp() {
          const now = new Date();
          return now.toTimeString().split(' ')[0] + '.' + now.getMilliseconds().toString().padStart(3, '0');
        }

        function log(message, type = 'info') {
          const timestamp = formatTimestamp();
          const logEntry = document.createElement('div');
          logEntry.style.marginBottom = '5px';

          const typeColors = {
            'info': '#0066cc',
            'success': '#008800',
            'error': '#cc0000',
            'warning': '#ff8800',
            'milestone': '#6600cc'
          };

          logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${typeColors[type] || '#000'}; font-weight: bold;">[${type.toUpperCase()}]</span> ${message}`;
          debugLogDiv.appendChild(logEntry);
          debugLogDiv.scrollTop = debugLogDiv.scrollHeight;

          console.log(`[DEBUG ${type}] ${message}`);
        }

        function clear() {
          debugLogDiv.innerHTML = '';
        }

        // Toggle button handler
        toggleBtn.addEventListener('click', function() {
          if (debugLogDiv.style.display === 'none') {
            debugLogDiv.style.display = 'block';
            toggleBtn.textContent = 'Hide Debug Logs';
          } else {
            debugLogDiv.style.display = 'none';
            toggleBtn.textContent = 'Show Debug Logs';
          }
        });

        // Initialize button text
        toggleBtn.textContent = 'Show Debug Logs';

        return {
          log: log,
          info: function(msg) { log(msg, 'info'); },
          success: function(msg) { log(msg, 'success'); },
          error: function(msg) { log(msg, 'error'); },
          warning: function(msg) { log(msg, 'warning'); },
          milestone: function(msg) { log(msg, 'milestone'); },
          clear: clear
        };
      })();

      // Global error handler for unhandled exceptions
      window.addEventListener('error', function(event) {
        window.debugLog.error(`Unhandled exception: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`);
        if (event.error && event.error.stack) {
          window.debugLog.error(`Stack trace: ${event.error.stack}`);
        }
      });

      // Global promise rejection handler
      window.addEventListener('unhandledrejection', function(event) {
        window.debugLog.error(`Unhandled promise rejection: ${event.reason}`);
        if (event.reason && event.reason.stack) {
          window.debugLog.error(`Stack trace: ${event.reason.stack}`);
        }
      });

      // Log page load
      window.debugLog.milestone('Page loaded - Java in the Browser initialized');
    </script>

    <script type="module">
      import { loadJavac } from "./javac-api.js";

      window.debugLog.milestone('Starting javac module load');
      loadJavac({ scriptUrl: "javac/javac.nocache.js" })
        .then(function (javac) {
          window.jibJavac = javac;
          window.debugLog.success('Javac module loaded successfully');
        })
        .catch(function (error) {
          console.warn("Failed to load javac API", error);
          window.debugLog.error(`Failed to load javac API: ${error.message}`);
        });
    </script>

  </body>
</html>
