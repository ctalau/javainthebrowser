#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EXPERIMENT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
UPSTREAM_ROOT="$EXPERIMENT_DIR/upstream/openjdk-jdk-17"
WORK_ROOT="$EXPERIMENT_DIR/work/openjdk-jdk-17-reduced"

if [[ ! -f "$UPSTREAM_ROOT/src/jdk.compiler/share/classes/com/sun/tools/javac/main/Main.java" ]]; then
  echo "Missing fetched OpenJDK sources. Running fetch script first..."
  "$SCRIPT_DIR/fetch_javac17_sources.sh"
fi

rm -rf "$WORK_ROOT"
mkdir -p "$WORK_ROOT"

copy_tree() {
  local src_root="$1"
  local rel="$2"
  local src="$UPSTREAM_ROOT/$src_root/$rel"
  local dst="$WORK_ROOT/$src_root/$rel"
  if [[ -d "$src" ]]; then
    mkdir -p "$(dirname "$dst")"
    cp -R "$src" "$dst"
  else
    echo "warning: missing source subtree $src" >&2
  fi
}

# Core compiler implementation and public compiler/source APIs.
copy_tree "src/jdk.compiler/share/classes" "com/sun/tools/javac"
copy_tree "src/jdk.compiler/share/classes" "com/sun/source"

# Required dependencies for full javac source compilation in isolation.
copy_tree "src/java.compiler/share/classes" "javax/lang/model"
copy_tree "src/java.compiler/share/classes" "javax/tools"
copy_tree "src/java.base/share/classes" "jdk/internal/javac"

MANIFEST="$WORK_ROOT/REDUCTION_NOTES.md"
JAVA_FILE_COUNT=$(find "$WORK_ROOT/src" -name '*.java' | wc -l | tr -d ' ')
cat > "$MANIFEST" <<MANIFEST_EOF
# Reduced OpenJDK 17 javac source subset

This tree is generated by \
\
\`scripts/prepare_reduced_sources.sh\`

Included source roots from upstream:

- \`src/jdk.compiler/share/classes/com/sun/tools/javac\`
- \`src/jdk.compiler/share/classes/com/sun/source\`
- \`src/java.compiler/share/classes/javax/lang/model\`
- \`src/java.compiler/share/classes/javax/tools\`
- \`src/java.base/share/classes/jdk/internal/javac\`

This keeps the compiler implementation and required API dependencies for full
`javac` source compilation while excluding unrelated JDK modules.

Snapshot metrics:

- Java source files: ${JAVA_FILE_COUNT}
MANIFEST_EOF

echo "Prepared reduced source tree at: $WORK_ROOT"
echo "Java source files copied: $JAVA_FILE_COUNT"
echo "Reduction manifest: $MANIFEST"
