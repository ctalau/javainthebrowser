#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EXPERIMENT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
UPSTREAM_ROOT="$EXPERIMENT_DIR/upstream/openjdk-jdk-17"
WORK_ROOT="$EXPERIMENT_DIR/work/openjdk-jdk-17-reduced"

if [[ ! -f "$UPSTREAM_ROOT/src/jdk.compiler/share/classes/com/sun/tools/javac/main/Main.java" ]]; then
  echo "Missing fetched OpenJDK sources. Running fetch script first..."
  "$SCRIPT_DIR/fetch_javac17_sources.sh"
fi

rm -rf "$WORK_ROOT"
mkdir -p "$WORK_ROOT/src/jdk.compiler/share/classes"

copy_tree() {
  local rel="$1"
  local src="$UPSTREAM_ROOT/src/jdk.compiler/share/classes/$rel"
  local dst="$WORK_ROOT/src/jdk.compiler/share/classes/$rel"
  if [[ -d "$src" ]]; then
    mkdir -p "$(dirname "$dst")"
    cp -R "$src" "$dst"
  else
    echo "warning: missing source subtree $src" >&2
  fi
}

# Keep a focused subset that includes the full javac implementation and public source model APIs.
copy_tree "com/sun/tools/javac"
copy_tree "com/sun/source"

MANIFEST="$WORK_ROOT/REDUCTION_NOTES.md"
JAVA_FILE_COUNT=$(find "$WORK_ROOT/src/jdk.compiler/share/classes" -name '*.java' | wc -l | tr -d ' ')
cat > "$MANIFEST" <<MANIFEST_EOF
# Reduced OpenJDK 17 javac source subset

This tree is generated by \
\
\`scripts/prepare_reduced_sources.sh\`\

Included source roots from upstream \`src/jdk.compiler/share/classes\`:

- \`com/sun/tools/javac\`
- \`com/sun/source\`

This keeps the compiler implementation and language model API while excluding unrelated JDK modules.

Snapshot metrics:

- Java source files: ${JAVA_FILE_COUNT}
MANIFEST_EOF

echo "Prepared reduced source tree at: $WORK_ROOT"
echo "Java source files copied: $JAVA_FILE_COUNT"
echo "Reduction manifest: $MANIFEST"
